
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Improve performance and maintainability with a prefetching layer in your Django / Django REST Framework project.">
      
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.6">
    
    
      
        <title>Tutorial - django-virtual-models</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#7e56c2">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#example-models" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="django-virtual-models" class="md-header__button md-logo" aria-label="django-virtual-models" data-md-component="logo">
      
  <img src="../img/4d-small.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            django-virtual-models
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/vintasoftware/django-virtual-models/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    vintasoftware/django-virtual-models
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="django-virtual-models" class="md-nav__button md-logo" aria-label="django-virtual-models" data-md-component="logo">
      
  <img src="../img/4d-small.svg" alt="logo">

    </a>
    django-virtual-models
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/vintasoftware/django-virtual-models/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    vintasoftware/django-virtual-models
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Tutorial
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Tutorial
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#example-models" class="md-nav__link">
    Example models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-django-virtual-models" class="md-nav__link">
    Why Django Virtual Models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-virtual-models-django-rest-framework-examples" class="md-nav__link">
    Defining Virtual Models (Django REST Framework examples)
  </a>
  
    <nav class="md-nav" aria-label="Defining Virtual Models (Django REST Framework examples)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#handling-prefetches-and-annotations" class="md-nav__link">
    Handling prefetches and annotations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-filtered-prefetches" class="md-nav__link">
    Using filtered prefetches
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-to_attr-prefetches" class="md-nav__link">
    Using to_attr prefetches
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-joins-select_related" class="md-nav__link">
    Using joins (select_related)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deferring-fields-with-deferred_fields" class="md-nav__link">
    Deferring fields with deferred_fields
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-data-relative-to-the-current-user" class="md-nav__link">
    Returning data relative to the current user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ignoring-a-serializer-field" class="md-nav__link">
    Ignoring a serializer field
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefetch-hints-with-django-rest-framework" class="md-nav__link">
    Prefetch hints with Django REST Framework
  </a>
  
    <nav class="md-nav" aria-label="Prefetch hints with Django REST Framework">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefetching-for-method-fields-serializermethodfield" class="md-nav__link">
    Prefetching for method fields (SerializerMethodField)
  </a>
  
    <nav class="md-nav" aria-label="Prefetching for method fields (SerializerMethodField)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-type-hints-with-hintsvirtual" class="md-nav__link">
    Using type hints with hints.Virtual
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-from_types_of-decorator" class="md-nav__link">
    Using from_types_of decorator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-you-already-defined-the-field-on-the-virtual-model" class="md-nav__link">
    If you already defined the field on the virtual model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-you-only-use-concrete-fields" class="md-nav__link">
    If you only use concrete fields
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefetching-for-model-properties-and-methods" class="md-nav__link">
    Prefetching for model properties and methods
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-virtual-models-manually" class="md-nav__link">
    Using Virtual Models manually
  </a>
  
    <nav class="md-nav" aria-label="Using Virtual Models manually">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-optimized-querysets" class="md-nav__link">
    Getting optimized querysets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-down-kwargs" class="md-nav__link">
    Passing down **kwargs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-drf-serializer-integration-works" class="md-nav__link">
    How DRF serializer integration works
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Releases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Releases" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Releases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../CHANGELOG/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../LICENSE/" class="md-nav__link">
        License
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#example-models" class="md-nav__link">
    Example models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-django-virtual-models" class="md-nav__link">
    Why Django Virtual Models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-virtual-models-django-rest-framework-examples" class="md-nav__link">
    Defining Virtual Models (Django REST Framework examples)
  </a>
  
    <nav class="md-nav" aria-label="Defining Virtual Models (Django REST Framework examples)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#handling-prefetches-and-annotations" class="md-nav__link">
    Handling prefetches and annotations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-filtered-prefetches" class="md-nav__link">
    Using filtered prefetches
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-to_attr-prefetches" class="md-nav__link">
    Using to_attr prefetches
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-joins-select_related" class="md-nav__link">
    Using joins (select_related)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deferring-fields-with-deferred_fields" class="md-nav__link">
    Deferring fields with deferred_fields
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-data-relative-to-the-current-user" class="md-nav__link">
    Returning data relative to the current user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ignoring-a-serializer-field" class="md-nav__link">
    Ignoring a serializer field
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prefetch-hints-with-django-rest-framework" class="md-nav__link">
    Prefetch hints with Django REST Framework
  </a>
  
    <nav class="md-nav" aria-label="Prefetch hints with Django REST Framework">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prefetching-for-method-fields-serializermethodfield" class="md-nav__link">
    Prefetching for method fields (SerializerMethodField)
  </a>
  
    <nav class="md-nav" aria-label="Prefetching for method fields (SerializerMethodField)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-type-hints-with-hintsvirtual" class="md-nav__link">
    Using type hints with hints.Virtual
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-from_types_of-decorator" class="md-nav__link">
    Using from_types_of decorator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-you-already-defined-the-field-on-the-virtual-model" class="md-nav__link">
    If you already defined the field on the virtual model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-you-only-use-concrete-fields" class="md-nav__link">
    If you only use concrete fields
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefetching-for-model-properties-and-methods" class="md-nav__link">
    Prefetching for model properties and methods
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-virtual-models-manually" class="md-nav__link">
    Using Virtual Models manually
  </a>
  
    <nav class="md-nav" aria-label="Using Virtual Models manually">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-optimized-querysets" class="md-nav__link">
    Getting optimized querysets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-down-kwargs" class="md-nav__link">
    Passing down **kwargs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-drf-serializer-integration-works" class="md-nav__link">
    How DRF serializer integration works
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/vintasoftware/django-virtual-models/blob/main/docs/tutorial.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>Tutorial</h1>

<h2 id="example-models">Example models<a class="headerlink" href="#example-models" title="Permanent link">&para;</a></h2>
<p>This tutorial will use the following Django models:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">biography</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Nomination</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">award</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Person</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;nominations&quot;</span><span class="p">)</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;Movie&quot;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;nominations&quot;</span><span class="p">)</span>
    <span class="n">is_winner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PersonDirector</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;Movie&quot;</span><span class="p">)</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">directors</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">Person</span><span class="p">,</span>
        <span class="n">through</span><span class="o">=</span><span class="n">PersonDirector</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;directed_movies&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<h2 id="why-django-virtual-models">Why Django Virtual Models<a class="headerlink" href="#why-django-virtual-models" title="Permanent link">&para;</a></h2>
<p>Due to the way Django (and especially Django REST Framework) projects are structured, read logic is usually far from prefetch and annotation logic, but both are coupled. This coupling results in brittle code that suffers from <a href="https://en.wikiversity.org/wiki/Software_Design/Change_amplification"><em>change amplification</em></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section describes the change amplification problem using Django REST Framework as an example, but other API frameworks (and sometimes Django-only codebases) suffer from similar problems because read logic is naturally coupled to prefetch and annotation logic. Please keep reading to check if Django Virtual Models is helpful to you. Then, the <a href="#using-virtual-models-manually">"Using Virtual Models manually"</a> section to learn how to use this library without DRF.</p>
</div>
<p>Imagine you have the following DRF serializers:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PersonSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MovieSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">directors</span> <span class="o">=</span> <span class="n">PersonSerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;directors&quot;</span><span class="p">]</span>
</code></pre></div>
<p>Now, for every view that uses <code>MovieSerializer</code> you'll have to remember to do the following prefetch in every <code>get_queryset</code> method:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MovieListView</span><span class="p">(</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MovieSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s2">&quot;directors&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MovieDetailView</span><span class="p">(</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MovieSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s2">&quot;directors&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Otherwise you'll get the <a href="https://stackoverflow.com/questions/97197/what-is-the-n1-selects-problem-in-orm-object-relational-mapping"><em>N+1 selects problem</em></a>, which is a possibly the main cause of performance issues in Django applications.</p>
<p>As the codebase gets more functionality, the problems get worse, and not only for N+1s. For example, if you add a new field inside <code>PersonSerializer</code>, like one that comes from an <code>annotate</code>, now you have to remember to call that <code>annotate</code> in all views that use <code>MovieSerializer</code>, because it has <code>PersonSerializer</code> nested on it:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Adding `nomination_count` here...</span>
<span class="k">class</span> <span class="nc">PersonSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">nomination_count</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;nomination_count&quot;</span><span class="p">]</span>

<span class="c1"># ... requires changes here:</span>
<span class="k">def</span> <span class="nf">queryset_ops_for_MovieSerializer</span><span class="p">(</span><span class="n">qs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span>
        <span class="n">Prefetch</span><span class="p">(</span>
            <span class="s2">&quot;directors&quot;</span><span class="p">,</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">nomination_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;nominations&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">MovieListView</span><span class="p">(</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MovieSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">queryset_ops_for_MovieSerializer</span><span class="p">(</span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">MovieDetailView</span><span class="p">(</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MovieSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">queryset_ops_for_MovieSerializer</span><span class="p">(</span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</code></pre></div>
<p>Any change that requires a <code>annotate</code>, <code>select_related</code>, and <code>prefetch_related</code> in <code>MovieSerializer</code> or any of its nested serializers like <code>PersonSerializer</code> will demand changes in (possibly) many view classes. As views and serializers are usually not in the same Python module, it's hard to ensure those coordinated changes while coding and it's even harder to review that in Pull Requests. Read logic is naturally coupled to prefetch and annotation logic!</p>
<p>But at first glance, it seems the solution is abstracting the queryset operations in a function. Is that robust? What if we're using <code>PersonSerializer</code> in another view? We would have to abstract again with another function:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">queryset_ops_for_PersonSerializer</span><span class="p">(</span><span class="n">qs</span><span class="p">):</span>  <span class="c1"># &lt;--- need this now</span>
    <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="n">nomination_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;nominations&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">queryset_ops_for_MovieSerializer</span><span class="p">(</span><span class="n">qs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span>
        <span class="n">Prefetch</span><span class="p">(</span>
            <span class="s2">&quot;directors&quot;</span><span class="p">,</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">queryset_ops_for_PersonSerializer</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objetcs</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">MovieListView</span><span class="p">(</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MovieSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">queryset_ops_for_MovieSerializer</span><span class="p">(</span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">MovieDetailView</span><span class="p">(</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MovieSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">queryset_ops_for_MovieSerializer</span><span class="p">(</span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">PersonView</span><span class="p">(</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PersonSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">queryset_ops_for_PersonSerializer</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</code></pre></div>
<p>This rapidly results in a unwieldy codebase, and still suffers from change amplification. It's easy to nest serializers, but it's hard to nest those queryset operations because you have to change code in multiple places. As you can see, the queryset logic is always coupled with the serializer logic... so why not handle both things together somehow?</p>
<p>What if we had a tool that warns us about missing annotations and prefetches by reading a serializer and infering what queryset operations it needs? That's exactly what Django Virtual Models do.</p>
<h2 id="defining-virtual-models-django-rest-framework-examples">Defining Virtual Models (Django REST Framework examples)<a class="headerlink" href="#defining-virtual-models-django-rest-framework-examples" title="Permanent link">&para;</a></h2>
<h3 id="handling-prefetches-and-annotations">Handling prefetches and annotations<a class="headerlink" href="#handling-prefetches-and-annotations" title="Permanent link">&para;</a></h3>
<p>To solve the change amplification on view querysets vs. serializers, the key is to create another layer to remove the responsibility from the view to set the queryset operations the serializer needs. That layer is the Virtual Model. The minimum virtual model looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">django_virtual_models</span> <span class="k">as</span> <span class="nn">v</span>

<span class="k">class</span> <span class="nc">VirtualMovie</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
</code></pre></div>
<p>The best thing is: this is already usable. Although the only purpose to use an empty Virtual Model is to get an exception...</p>
<p>But that's what you want! The idea is to be guided by the virtual model exceptions to know what fields you need to add to it. First, integrate the <code>VirtualMovie</code> with the <code>MovieSerializer</code> and the view by doing the following:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">django_virtual_models</span> <span class="k">as</span> <span class="nn">v</span>

<span class="k">class</span> <span class="nc">MovieSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="n">directors</span> <span class="o">=</span> <span class="n">PersonSerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
        <span class="n">virtual_model</span> <span class="o">=</span> <span class="n">VirtualMovie</span>  <span class="c1"># &lt;--- add this</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;directors&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">MovieListView</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelListAPIView</span><span class="p">):</span>  <span class="c1"># &lt;--- changed base class</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MovieSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MovieDetailView</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelRetrieveAPIView</span><span class="p">):</span>  <span class="c1"># &lt;--- changed base class</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">MovieSerializer</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>
<p>Now, if we try to access the <code>MovieListView</code> by hitting its URL, we get the following exception:</p>
<div class="highlight"><pre><span></span><code>MissingVirtualModelFieldException at /movies/
`directors` must be defined in `VirtualMovie` because it&#39;s a nested serializer on `MovieSerializer`
</code></pre></div>
<p>In the browser, it looks like this:</p>
<p><img alt="MissingVirtualModelFieldException for directors" src="https://user-images.githubusercontent.com/397989/194100101-344b89e3-faf9-4e9a-a69e-8ee1e6e480d5.png" /></p>
<p>The exception is clearly telling us we need a <code>directors</code> field inside <code>VirtualMovie</code>. Since it's a relationship between models, we're going to create an empty Virtual Model for <code>Person</code> and reference it in the <code>directors</code> field:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualPerson</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>  <span class="c1"># &lt;--- new virtual model...</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>

<span class="k">class</span> <span class="nc">VirtualMovie</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">directors</span> <span class="o">=</span> <span class="n">VirtualPerson</span><span class="p">()</span>  <span class="c1"># &lt;--- ...nested here</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
</code></pre></div>
<p>Hitting the <code>MovieListView</code> URL again, we get another exception:</p>
<div class="highlight"><pre><span></span><code>MissingVirtualModelFieldException at /movies/
`nomination_count` used by `PersonSerializer` must be defined in `VirtualPerson` (nested on `VirtualMovie`)
</code></pre></div>
<p>Now let's add <code>nomination_count</code> to <code>VirtualPerson</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualPerson</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">nomination_count</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">qs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">nomination_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;nominations&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>
</code></pre></div>
<p>Now the view works fine, without any N+1 queries or missing annotations! The <code>VirtualModelListAPIView</code> automatically uses the serializer and its virtual model to get an optimized queryset by overriding the <code>get_queryset</code> method.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you override the <code>get_queryset</code> method without calling super, the virtual model integration will not work. Either call <code>super().get_queryset()</code> or use the <code>GenericVirtualModelViewMixin</code> in case you have custom base view classes. Read more about why on section <a href="#how-drf-serializer-integration-works">"How DRF serializer integration works"</a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you already use a custom serializer class, use the <code>VirtualModelSerializerMixin</code>. Check the <a href="https://github.com/vintasoftware/django-virtual-models/blob/main/django_virtual_models/serializers.py">source code</a> to learn how it works.</p>
</div>
<h3 id="using-filtered-prefetches">Using filtered prefetches<a class="headerlink" href="#using-filtered-prefetches" title="Permanent link">&para;</a></h3>
<p>If you need to prefetch a relationship with some filtering, you can define a method called <code>get_prefetch_queryset</code> inside the <code>VirtualModel</code>. Suppose we need to fetch only the nominations that a person won (with <code>is_winner=True</code>). It's simple to do that:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualAward</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Nomination</span>

    <span class="k">def</span> <span class="nf">get_prefetch_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># &lt;--- filter call here</span>
        <span class="k">return</span> <span class="n">Nomination</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_winner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">VirtualPerson</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">awards</span> <span class="o">=</span> <span class="n">VirtualAward</span><span class="p">(</span>
        <span class="n">lookup</span><span class="o">=</span><span class="s2">&quot;nominations&quot;</span>  <span class="c1"># &lt;--- the non-filtered relation name</span>
    <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>
</code></pre></div>
<h3 id="using-to_attr-prefetches">Using <code>to_attr</code> prefetches<a class="headerlink" href="#using-to_attr-prefetches" title="Permanent link">&para;</a></h3>
<p>As you can see in the previous example, you can specify the <code>to_attr</code> in nested virtual models, just as the regular <code>Prefetch</code> from Django. Remember to set both the <code>lookup</code> and the <code>to_attr</code>, as the left side attribute name corresponds to the field name in the serializer. In general, <code>to_attr</code> and the attribute name should be the same.</p>
<h3 id="using-joins-select_related">Using joins (<code>select_related</code>)<a class="headerlink" href="#using-joins-select_related" title="Permanent link">&para;</a></h3>
<p>If you want the same functionality of Django's <code>select_related</code>, you can use a <code>NestedJoin</code> field in the virtual model:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualNomination</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">NestedJoin</span><span class="p">(</span><span class="n">model_cls</span><span class="o">=</span><span class="n">Person</span><span class="p">)</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">NestedJoin</span><span class="p">(</span><span class="n">model_cls</span><span class="o">=</span><span class="n">Movie</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Nomination</span>
</code></pre></div>
<p>With this, any access to <code>nomination.person</code> or <code>nomination.movie</code> won't make additional queries. Therefore, you can have nested serializers for those fields.</p>
<p>However, if those nested serializers have their own non-concrete fields (annotations or other nested serializers), then the virtual model will launch an exception with a message like this:</p>
<div class="highlight"><pre><span></span><code>Cannot use a `NestedJoin` for `person` inside `VirtualNomination`.
`directors` must be a field of `person`,
because it&#39;s a nested serializer on `NominationSerializer`.
Change from `NestedJoin` to a `VirtualModel` and add `directors` as a field.
</code></pre></div>
<p>In other words, for further nesting you'll need nested <code>VirtualModel</code>s (which are nested prefetches behind the scenes).</p>
<h3 id="deferring-fields-with-deferred_fields">Deferring fields with <code>deferred_fields</code><a class="headerlink" href="#deferring-fields-with-deferred_fields" title="Permanent link">&para;</a></h3>
<p>As Django's default behavior for querysets, Virtual Models load all concrete fields (all DB columns from the table) by default. If you have a model that contains concrete fields that are expensive to fetch, such as a <code>TextField</code> or a <code>JSONField</code> with lots of data, you can use <code>deferred_fields</code> to avoid fetching them:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualPerson</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>
        <span class="n">deferred_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;biography&quot;</span><span class="p">]</span>
</code></pre></div>
<p>Note this only makes a difference if the <code>biography</code> field is <em>not</em> declared in your serializer's <code>Meta.fields</code>. If it's there, this library assumes you'll need that field and will include it in the queryset to prevent N+1 queries.</p>
<p>But if you don't have the <code>biography</code> field in your serializer, any access to <code>person.biography</code> will make a new query. This is the same behavior of using <code>Person.objects.defer("biography")</code> in regular Django.</p>
<h3 id="returning-data-relative-to-the-current-user">Returning data relative to the current user<a class="headerlink" href="#returning-data-relative-to-the-current-user" title="Permanent link">&para;</a></h3>
<p>Sometimes it makes sense to include data relative to the current user in the virtual model fields.</p>
<p>Imagine you have a <code>UserMovieRating</code> model that relates users with movies and has a rating field:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">UserMovieRating</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">)</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;Movie&quot;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;ratings&quot;</span><span class="p">)</span>
    <span class="n">rating</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">(</span><span class="n">max_digits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">decimal_places</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>You can add a field for <code>user_rating</code> in a <code>MovieSerializer</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MovieSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="n">user_rating</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">(</span><span class="n">max_digits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">decimal_places</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
        <span class="n">virtual_model</span> <span class="o">=</span> <span class="n">VirtualMovie</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;user_rating&quot;</span><span class="p">]</span>
</code></pre></div>
<p>But you need to declare <code>user_rating</code> on <code>VirtualMovie</code> and ensure it is fetching the rating for the current user. This is possble with the following code:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualMovie</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">user_rating</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span>
        <span class="c1"># Note `user` is an argument here:</span>
        <span class="k">lambda</span> <span class="n">qs</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">Subquery</span><span class="p">(</span>
                <span class="n">UserMovieRating</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">movie</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">),</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">user</span>
                <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
</code></pre></div>
<p>The <code>user</code> argument is available on <code>v.Annotation</code> thanks to <code>v.VirtualModelSerializer</code> that gets the current user from <code>self.context["request"].user</code>.</p>
<p>The <code>user</code> argument is also available on <code>get_prefetch_queryset</code> for use in filtered prefetches. Therefore, the following code works:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualUserMovieRating</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">UserMovieRating</span>

    <span class="k">def</span> <span class="nf">get_prefetch_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># &lt;--- here</span>
        <span class="k">return</span> <span class="n">UserMovieRating</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>An advice: in general, you should avoid returning data relative to the current user in HTTP APIs, as this makes caching very hard or even impossible. Use this only if you really need it, as in a request that's only specific for users like user profile pages. Avoid nesting data related to the current user inside global data. Consider adding an additional request to fetch data relative to the current user, and then "hydrate" the previous request data on the frontend.</p>
</div>
<h3 id="ignoring-a-serializer-field">Ignoring a serializer field<a class="headerlink" href="#ignoring-a-serializer-field" title="Permanent link">&para;</a></h3>
<p>If you have a serializer field that fetches data from somewhere other than your Django models, you cannot prefetch data for it with a Virtual Model. So you need to make the Virtual Model ignore that field.</p>
<p>Suppose you have some serializer that fetches data from an external service:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">IMDBRatingField</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches the IMDB Rating for the movie.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">MovieSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="n">imdb_rating</span> <span class="o">=</span> <span class="n">IMDBRatingField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
        <span class="n">virtual_model</span> <span class="o">=</span> <span class="n">VirtualMovie</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;imdb_rating&quot;</span><span class="p">]</span>
</code></pre></div>
<p>You need to mark <code>imdb_rating</code> as something to be ignored in the <code>VirtualMovie</code>. Use <code>v.NoOp()</code> for that:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualMovie</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">imdb_rating</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">NoOp</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
</code></pre></div>
<h2 id="prefetch-hints-with-django-rest-framework">Prefetch hints with Django REST Framework<a class="headerlink" href="#prefetch-hints-with-django-rest-framework" title="Permanent link">&para;</a></h2>
<p>If your DRF serializer uses method fields, model methods or properties, you can still use Virtual Models with it! But you need to add some <em>prefetch hints</em>.</p>
<h3 id="prefetching-for-method-fields-serializermethodfield">Prefetching for method fields (<code>SerializerMethodField</code>)<a class="headerlink" href="#prefetching-for-method-fields-serializermethodfield" title="Permanent link">&para;</a></h3>
<p>It's very common to use <code>SerializerMethodField</code> in DRF serializers. If those method fields need some virtual model fields, you need to specify that. Suppose you have the following virtual model and serializer:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualPerson</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">awards</span> <span class="o">=</span> <span class="n">VirtualAward</span><span class="p">(</span><span class="n">lookup</span><span class="o">=</span><span class="s2">&quot;nominations&quot;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>

<span class="k">class</span> <span class="nc">PersonSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="n">has_won_any_award</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>
        <span class="n">virtual_model</span> <span class="o">=</span> <span class="n">VirtualPerson</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;has_won_any_award&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_has_won_any_award</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person</span><span class="p">):</span>
        <span class="c1"># How to ensure `person` will have `awards`?</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">awards</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>
<p>This serializer needs the <code>awards</code> field from <code>VirtualPerson</code> inside <code>get_has_won_any_award</code> method, otherwise it would raise an <code>AttributeError</code> as this is a <em>virtual field</em>. But how to specify that requirement? There are multiple ways of doing this:</p>
<h4 id="using-type-hints-with-hintsvirtual">Using type hints with <code>hints.Virtual</code><a class="headerlink" href="#using-type-hints-with-hintsvirtual" title="Permanent link">&para;</a></h4>
<p>This library supports special type hints for informing what virtual fields a serializer method needs:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Python &lt; 3.9. For &gt;= 3.9, use `from typing import Annotated`:</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span> <span class="nn">django_virtual_models</span> <span class="kn">import</span> <span class="n">hints</span>

<span class="k">class</span> <span class="nc">PersonSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">get_has_won_any_award</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="c1"># Type hint to ensure `awards` here:</span>
        <span class="n">person</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Person</span><span class="p">,</span> <span class="n">hints</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="s2">&quot;awards&quot;</span><span class="p">)]</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">awards</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>
<p>Now thanks to <code>hints.Virtual("awards")</code>, this serializer will be able to require the field <code>awards</code> from the virtual model. If necessary, you can pass multiple fields or even nested lookups: <code>hints.Virtual("awards", "nominations__movie")</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>hints.Virtual</code> can be used to ensure the fetching of any <code>deferred_fields</code> a method needs without N+1s.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a href="https://docs.python.org/3/library/typing.html#typing.Annotated">Annotated</a> is a built-in Python construct that allows us to add custom annotations that don't affect type checking.</p>
</div>
<h4 id="using-from_types_of-decorator">Using <code>from_types_of</code> decorator<a class="headerlink" href="#using-from_types_of-decorator" title="Permanent link">&para;</a></h4>
<p>If your method calls another function, you can add type hints to that function with <code>hints.Virtual</code> and then use the <code>from_types_of</code> decorator:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Python &lt; 3.9. For &gt;= 3.9, use `from typing import Annotated`:</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span> <span class="nn">django_virtual_models</span> <span class="kn">import</span> <span class="n">hints</span>

<span class="k">def</span> <span class="nf">check_person_has_won_any_award</span><span class="p">(</span>
    <span class="c1"># Type hint to ensure `awards` here:</span>
    <span class="n">person</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Person</span><span class="p">,</span> <span class="n">hints</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="s2">&quot;awards&quot;</span><span class="p">)]</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">awards</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">PersonSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="c1"># Decorator to specify where to find the type hint here:</span>
    <span class="nd">@hints</span><span class="o">.</span><span class="n">from_types_of</span><span class="p">(</span><span class="n">check_person_has_won_any_award</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_has_won_any_award</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">check_person_has_won_any_award</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">check_person_has_won_any_award</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
</code></pre></div>
<p>Note the function <code>check_person_has_won_any_award</code> is received in the decorator and passed to the method as an additional argument. This allow serializer methods to fully delegate their logic to some external helper function. Use that only if you really need that kind of indirection.</p>
<h4 id="if-you-already-defined-the-field-on-the-virtual-model">If you already defined the field on the virtual model<a class="headerlink" href="#if-you-already-defined-the-field-on-the-virtual-model" title="Permanent link">&para;</a></h4>
<p>If you have the <code>has_won_any_award</code> field in your virtual model, you can use the <code>defined_on_virtual_model</code> decorator:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django_virtual_models</span> <span class="kn">import</span> <span class="n">hints</span>

<span class="k">class</span> <span class="nc">PersonSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="nd">@hints</span><span class="o">.</span><span class="n">defined_on_virtual_model</span><span class="p">()</span>  <span class="c1"># &lt;--- here</span>
    <span class="k">def</span> <span class="nf">get_has_won_any_award</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="n">has_won_any_award</span>
</code></pre></div>
<h4 id="if-you-only-use-concrete-fields">If you only use concrete fields<a class="headerlink" href="#if-you-only-use-concrete-fields" title="Permanent link">&para;</a></h4>
<p>If your method field only uses concrete fields, in other words, it doesn't depend on any virtual model fields, nor any <code>deferred_fields</code>, you can use the <code>no_deferred_fields</code> decorator:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django_virtual_models</span> <span class="kn">import</span> <span class="n">hints</span>

<span class="k">class</span> <span class="nc">PersonSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="n">name_title_case</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>
        <span class="n">virtual_model</span> <span class="o">=</span> <span class="n">VirtualPerson</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name_title_case&quot;</span><span class="p">]</span>

    <span class="nd">@hints</span><span class="o">.</span><span class="n">no_deferred_fields</span><span class="p">()</span>  <span class="c1"># &lt;--- here</span>
    <span class="k">def</span> <span class="nf">get_name_title_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
</code></pre></div>
<h3 id="prefetching-for-model-properties-and-methods">Prefetching for model properties and methods<a class="headerlink" href="#prefetching-for-model-properties-and-methods" title="Permanent link">&para;</a></h3>
<p>DRF Serializers can use directly model properties and methods in <code>Meta.fields</code>. If your serializer uses a model property or method, you need to use the same hints described by the previous section <a href="#prefetching-for-method-fields-serializermethodfield">"Prefetching for method fields"</a>. For example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django_virtual_models</span> <span class="kn">import</span> <span class="n">hints</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="nd">@property</span>  <span class="c1"># &lt;--- property must come before</span>
    <span class="nd">@hints</span><span class="o">.</span><span class="n">no_deferred_fields</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">name_title_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

    <span class="c1"># method w/o params, DRF supports that too:</span>
    <span class="k">def</span> <span class="nf">has_won_any_award</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Person</span><span class="p">,</span> <span class="n">hints</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="s2">&quot;awards&quot;</span><span class="p">)]):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">awards</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">PersonSerializer</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>
        <span class="n">virtual_model</span> <span class="o">=</span> <span class="n">VirtualPerson</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name_title_case&quot;</span><span class="p">,</span> <span class="s2">&quot;has_won_any_award&quot;</span><span class="p">]</span>  <span class="c1">#  &lt;--- this works</span>
</code></pre></div>
<h2 id="using-virtual-models-manually">Using Virtual Models manually<a class="headerlink" href="#using-virtual-models-manually" title="Permanent link">&para;</a></h2>
<h3 id="getting-optimized-querysets">Getting optimized querysets<a class="headerlink" href="#getting-optimized-querysets" title="Permanent link">&para;</a></h3>
<p>If you do not use Django REST Framework, you can still benefit from using Virtual Models to avoid maintaining annotations and prefetches across several parts of your codebase. By centralizing the read logic in virtual models, you reduce cognitive load and change amplification.</p>
<p>Consider the following virtual models:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VirtualAward</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Nomination</span>

    <span class="k">def</span> <span class="nf">get_prefetch_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Nomination</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_winner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">VirtualPerson</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">awards</span> <span class="o">=</span> <span class="n">VirtualAward</span><span class="p">(</span><span class="n">lookup</span><span class="o">=</span><span class="s2">&quot;nominations&quot;</span><span class="p">)</span>
    <span class="n">nomination_count</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">qs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">nomination_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;nominations&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Person</span>


<span class="k">class</span> <span class="nc">VirtualMovie</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="n">directors</span> <span class="o">=</span> <span class="n">VirtualPerson</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Movie</span>
</code></pre></div>
<p>You can hydrate an existing queryset with those virtual fields by using a syntax similar to Django lookups:</p>
<div class="highlight"><pre><span></span><code><span class="n">qs</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<span class="n">optimized_qs</span> <span class="o">=</span> <span class="n">VirtualMovie</span><span class="p">()</span><span class="o">.</span><span class="n">get_optimized_queryset</span><span class="p">(</span>
    <span class="n">qs</span><span class="p">,</span>
    <span class="n">lookup_list</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;directors__awards&quot;</span><span class="p">,</span>
        <span class="s2">&quot;directors__nomination_count&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>
<p>When the <code>lookup_list</code> omits a virtual field, it is not included in the optimized queryset.</p>
<p>If you want to get all virtual fields, pass <code>lookup_list=None</code> or omit the parameter.</p>
<h3 id="passing-down-kwargs">Passing down <code>**kwargs</code><a class="headerlink" href="#passing-down-kwargs" title="Permanent link">&para;</a></h3>
<p>The keyword arguments you pass in the virtual model constructor are passed down to <code>v.Annotate</code> and <code>get_prefetch_queryset</code> of all nested virtual models.</p>
<h3 id="how-drf-serializer-integration-works">How DRF serializer integration works<a class="headerlink" href="#how-drf-serializer-integration-works" title="Permanent link">&para;</a></h3>
<p>The main logic that connects DRF serializers with Virtual Models is on <code>LookupFinder</code> (<a href="https://github.com/vintasoftware/django-virtual-models/blob/main/django_virtual_models/prefetch/serializer_optimization.py">source code</a>). The <code>LookupFinder</code> automatically discovers what virtual fields are needed and raise exceptions if they're not available in the virtual model associated with the serializer. It has a method called <code>recursively_find_lookup_list</code> that returns a <code>lookup_list</code> to be passed to serializer's virtual model. <code>recursively_find_lookup_list</code> is called on <code>get_queryset</code> from <code>GenericVirtualModelViewMixin</code> (<a href="https://github.com/vintasoftware/django-virtual-models/blob/main/django_virtual_models/generic_views.py">source code</a>).</p>
<p>If necessary, you can customize this logic in your own view classes.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../installation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Installation" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Installation
            </div>
          </div>
        </a>
      
      
        
        <a href="../CHANGELOG/" class="md-footer__link md-footer__link--next" aria-label="Next: Changelog" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Changelog
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <a href="https://www.vinta.com.br">Vinta Software</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>